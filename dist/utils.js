"use strict";

// augment Sylvester some
Matrix.Translation = function (v) {
    if (v.elements.length == 2) {
        var r = Matrix.I(3);
        r.elements[2][0] = v.elements[0];
        r.elements[2][1] = v.elements[1];
        return r;
    }

    if (v.elements.length == 3) {
        var r = Matrix.I(4);
        r.elements[0][3] = v.elements[0];
        r.elements[1][3] = v.elements[1];
        r.elements[2][3] = v.elements[2];
        return r;
    }

    throw "Invalid length for Translation";
};

Matrix.prototype.flatten = function () {
    var result = [];
    if (this.elements.length == 0) return [];

    for (var j = 0; j < this.elements[0].length; j++) {
        for (var i = 0; i < this.elements.length; i++) {
            result.push(this.elements[i][j]);
        }
    }return result;
};

Matrix.prototype.ensure4x4 = function () {
    if (this.elements.length == 4 && this.elements[0].length == 4) return this;

    if (this.elements.length > 4 || this.elements[0].length > 4) return null;

    for (var i = 0; i < this.elements.length; i++) {
        for (var j = this.elements[i].length; j < 4; j++) {
            if (i == j) this.elements[i].push(1);else this.elements[i].push(0);
        }
    }

    for (var i = this.elements.length; i < 4; i++) {
        if (i == 0) this.elements.push([1, 0, 0, 0]);else if (i == 1) this.elements.push([0, 1, 0, 0]);else if (i == 2) this.elements.push([0, 0, 1, 0]);else if (i == 3) this.elements.push([0, 0, 0, 1]);
    }

    return this;
};

Matrix.prototype.make3x3 = function () {
    if (this.elements.length != 4 || this.elements[0].length != 4) return null;

    return Matrix.create([[this.elements[0][0], this.elements[0][1], this.elements[0][2]], [this.elements[1][0], this.elements[1][1], this.elements[1][2]], [this.elements[2][0], this.elements[2][1], this.elements[2][2]]]);
};

Vector.prototype.flatten = function () {
    return this.elements;
};

function mht(m) {
    var s = "";
    if (m.length == 16) {
        for (var i = 0; i < 4; i++) {
            s += "<span style='font-family: monospace'>[" + m[i * 4 + 0].toFixed(4) + "," + m[i * 4 + 1].toFixed(4) + "," + m[i * 4 + 2].toFixed(4) + "," + m[i * 4 + 3].toFixed(4) + "]</span><br>";
        }
    } else if (m.length == 9) {
        for (var i = 0; i < 3; i++) {
            s += "<span style='font-family: monospace'>[" + m[i * 3 + 0].toFixed(4) + "," + m[i * 3 + 1].toFixed(4) + "," + m[i * 3 + 2].toFixed(4) + "]</font><br>";
        }
    } else {
        return m.toString();
    }
    return s;
}

//
// gluLookAt
//
function makeLookAt(ex, ey, ez, cx, cy, cz, ux, uy, uz) {
    var eye = $V([ex, ey, ez]);
    var center = $V([cx, cy, cz]);
    var up = $V([ux, uy, uz]);

    var mag;

    var z = eye.subtract(center).toUnitVector();
    var x = up.cross(z).toUnitVector();
    var y = z.cross(x).toUnitVector();

    var m = $M([[x.e(1), x.e(2), x.e(3), 0], [y.e(1), y.e(2), y.e(3), 0], [z.e(1), z.e(2), z.e(3), 0], [0, 0, 0, 1]]);

    var t = $M([[1, 0, 0, -ex], [0, 1, 0, -ey], [0, 0, 1, -ez], [0, 0, 0, 1]]);
    return m.x(t);
}

//
// glOrtho
//
function makeOrtho(left, right, bottom, top, znear, zfar) {
    var tx = -(right + left) / (right - left);
    var ty = -(top + bottom) / (top - bottom);
    var tz = -(zfar + znear) / (zfar - znear);

    return $M([[2 / (right - left), 0, 0, tx], [0, 2 / (top - bottom), 0, ty], [0, 0, -2 / (zfar - znear), tz], [0, 0, 0, 1]]);
}

//
// gluPerspective
//
function makePerspective(fovy, aspect, znear, zfar) {
    var ymax = znear * Math.tan(fovy * Math.PI / 360.0);
    var ymin = -ymax;
    var xmin = ymin * aspect;
    var xmax = ymax * aspect;

    return makeFrustum(xmin, xmax, ymin, ymax, znear, zfar);
}

//
// glFrustum
//
function makeFrustum(left, right, bottom, top, znear, zfar) {
    var X = 2 * znear / (right - left);
    var Y = 2 * znear / (top - bottom);
    var A = (right + left) / (right - left);
    var B = (top + bottom) / (top - bottom);
    var C = -(zfar + znear) / (zfar - znear);
    var D = -2 * zfar * znear / (zfar - znear);

    return $M([[X, 0, A, 0], [0, Y, B, 0], [0, 0, C, D], [0, 0, -1, 0]]);
}

//
// glOrtho
//
function makeOrtho(left, right, bottom, top, znear, zfar) {
    var tx = -(right + left) / (right - left);
    var ty = -(top + bottom) / (top - bottom);
    var tz = -(zfar + znear) / (zfar - znear);

    return $M([[2 / (right - left), 0, 0, tx], [0, 2 / (top - bottom), 0, ty], [0, 0, -2 / (zfar - znear), tz], [0, 0, 0, 1]]);
}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInV0aWxzLmpzIl0sIm5hbWVzIjpbIk1hdHJpeCIsIlRyYW5zbGF0aW9uIiwidiIsImVsZW1lbnRzIiwibGVuZ3RoIiwiciIsIkkiLCJwcm90b3R5cGUiLCJmbGF0dGVuIiwicmVzdWx0IiwiaiIsImkiLCJwdXNoIiwiZW5zdXJlNHg0IiwibWFrZTN4MyIsImNyZWF0ZSIsIlZlY3RvciIsIm1odCIsIm0iLCJzIiwidG9GaXhlZCIsInRvU3RyaW5nIiwibWFrZUxvb2tBdCIsImV4IiwiZXkiLCJleiIsImN4IiwiY3kiLCJjeiIsInV4IiwidXkiLCJ1eiIsImV5ZSIsIiRWIiwiY2VudGVyIiwidXAiLCJtYWciLCJ6Iiwic3VidHJhY3QiLCJ0b1VuaXRWZWN0b3IiLCJ4IiwiY3Jvc3MiLCJ5IiwiJE0iLCJlIiwidCIsIm1ha2VPcnRobyIsImxlZnQiLCJyaWdodCIsImJvdHRvbSIsInRvcCIsInpuZWFyIiwiemZhciIsInR4IiwidHkiLCJ0eiIsIm1ha2VQZXJzcGVjdGl2ZSIsImZvdnkiLCJhc3BlY3QiLCJ5bWF4IiwiTWF0aCIsInRhbiIsIlBJIiwieW1pbiIsInhtaW4iLCJ4bWF4IiwibWFrZUZydXN0dW0iLCJYIiwiWSIsIkEiLCJCIiwiQyIsIkQiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQUEsT0FBT0MsV0FBUCxHQUFxQixVQUFVQyxDQUFWLEVBQ3JCO0FBQ0UsUUFBSUEsRUFBRUMsUUFBRixDQUFXQyxNQUFYLElBQXFCLENBQXpCLEVBQTRCO0FBQzFCLFlBQUlDLElBQUlMLE9BQU9NLENBQVAsQ0FBUyxDQUFULENBQVI7QUFDQUQsVUFBRUYsUUFBRixDQUFXLENBQVgsRUFBYyxDQUFkLElBQW1CRCxFQUFFQyxRQUFGLENBQVcsQ0FBWCxDQUFuQjtBQUNBRSxVQUFFRixRQUFGLENBQVcsQ0FBWCxFQUFjLENBQWQsSUFBbUJELEVBQUVDLFFBQUYsQ0FBVyxDQUFYLENBQW5CO0FBQ0EsZUFBT0UsQ0FBUDtBQUNEOztBQUVELFFBQUlILEVBQUVDLFFBQUYs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LENBQUosRUFBTyxDQUFDLENBQVIsRUFBVyxDQUFYLENBSEQsQ0FBSCxDQUFQO0FBSUg7O0FBRUQ7QUFDQTtBQUNBO0FBQ0EsU0FBUzFCLFNBQVQsQ0FBbUJDLElBQW5CLEVBQXlCQyxLQUF6QixFQUFnQ0MsTUFBaEMsRUFBd0NDLEdBQXhDLEVBQTZDQyxLQUE3QyxFQUFvREMsSUFBcEQsRUFDQTtBQUNJLFFBQUlDLEtBQUssRUFBR0wsUUFBUUQsSUFBWCxLQUFvQkMsUUFBUUQsSUFBNUIsQ0FBVDtBQUNBLFFBQUlPLEtBQUssRUFBR0osTUFBTUQsTUFBVCxLQUFvQkMsTUFBTUQsTUFBMUIsQ0FBVDtBQUNBLFFBQUlNLEtBQUssRUFBR0gsT0FBT0QsS0FBVixLQUFvQkMsT0FBT0QsS0FBM0IsQ0FBVDs7QUFFQSxXQUFPUixHQUFHLENBQUMsQ0FBQyxLQUFLSyxRQUFRRCxJQUFiLENBQUQsRUFBcUIsQ0FBckIsRUFBd0IsQ0FBeEIsRUFBMkJNLEVBQTNCLENBQUQsRUFDSCxDQUFDLENBQUQsRUFBSSxLQUFLSCxNQUFNRCxNQUFYLENBQUosRUFBd0IsQ0FBeEIsRUFBMkJLLEVBQTNCLENBREcsRUFFSCxDQUFDLENBQUQsRUFBSSxDQUFKLEVBQU8sQ0FBQyxDQUFELElBQU1GLE9BQU9ELEtBQWIsQ0FBUCxFQUE0QkksRUFBNUIsQ0FGRyxFQUdILENBQUMsQ0FBRCxFQUFJLENBQUosRUFBTyxDQUFQLEVBQVUsQ0FBVixDQUhHLENBQUgsQ0FBUDtBQUlIIiwiZmlsZSI6InV0aWxzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gYXVnbWVudCBTeWx2ZXN0ZXIgc29tZVxyXG5NYXRyaXguVHJhbnNsYXRpb24gPSBmdW5jdGlvbiAodilcclxue1xyXG4gIGlmICh2LmVsZW1lbnRzLmxlbmd0aCA9PSAyKSB7XHJcbiAgICB2YXIgciA9IE1hdHJpeC5JKDMpO1xyXG4gICAgci5lbGVtZW50c1syXVswXSA9IHYuZWxlbWVudHNbMF07XHJcbiAgICByLmVsZW1lbnRzWzJdWzFdID0gdi5lbGVtZW50c1sxXTtcclxuICAgIHJldHVybiByO1xyXG4gIH1cclxuXHJcbiAgaWYgKHYuZWxlbWVudHMubGVuZ3RoID09IDMpIHtcclxuICAgIHZhciByID0gTWF0cml4LkkoNCk7XHJcbiAgICByLmVsZW1lbnRzWzBdWzNdID0gdi5lbGVtZW50c1swXTtcclxuICAgIHIuZWxlbWVudHNbMV1bM10gPSB2LmVsZW1lbnRzWzFdO1xyXG4gICAgci5lbGVtZW50c1syXVszXSA9IHYuZWxlbWVudHNbMl07XHJcbiAgICByZXR1cm4gcjtcclxuICB9XHJcblxyXG4gIHRocm93IFwiSW52YWxpZCBsZW5ndGggZm9yIFRyYW5zbGF0aW9uXCI7XHJcbn1cclxuXHJcbk1hdHJpeC5wcm90b3R5cGUuZmxhdHRlbiA9IGZ1bmN0aW9uICgpXHJcbntcclxuICAgIHZhciByZXN1bHQgPSBbXTtcclxuICAgIGlmICh0aGlzLmVsZW1lbnRzLmxlbmd0aCA9PSAwKVxyXG4gICAgICAgIHJldHVybiBbXTtcclxuXHJcblxyXG4gICAgZm9yICh2YXIgaiA9IDA7IGogPCB0aGlzLmVsZW1lbnRzWzBdLmxlbmd0aDsgaisrKVxyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5lbGVtZW50cy5sZW5ndGg7IGkrKylcclxuICAgICAgICAgICAgcmVzdWx0LnB1c2godGhpcy5lbGVtZW50c1tpXVtqXSk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG5NYXRyaXgucHJvdG90eXBlLmVuc3VyZTR4NCA9IGZ1bmN0aW9uKClcclxue1xyXG4gICAgaWYgKHRoaXMuZWxlbWVudHMubGVuZ3RoID09IDQgJiZcclxuICAgICAgICB0aGlzLmVsZW1lbnRzWzBdLmxlbmd0aCA9PSA0KVxyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG5cclxuICAgIGlmICh0aGlzLmVsZW1lbnRzLmxlbmd0aCA+IDQgfHxcclxuICAgICAgICB0aGlzLmVsZW1lbnRzWzBdLmxlbmd0aCA+IDQpXHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcblxyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgZm9yICh2YXIgaiA9IHRoaXMuZWxlbWVudHNbaV0ubGVuZ3RoOyBqIDwgNDsgaisrKSB7XHJcbiAgICAgICAgICAgIGlmIChpID09IGopXHJcbiAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnRzW2ldLnB1c2goMSk7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudHNbaV0ucHVzaCgwKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZm9yICh2YXIgaSA9IHRoaXMuZWxlbWVudHMubGVuZ3RoOyBpIDwgNDsgaSsrKSB7XHJcbiAgICAgICAgaWYgKGkgPT0gMClcclxuICAgICAgICAgICAgdGhpcy5lbGVtZW50cy5wdXNoKFsxLCAwLCAwLCAwXSk7XHJcbiAgICAgICAgZWxzZSBpZiAoaSA9PSAxKVxyXG4gICAgICAgICAgICB0aGlzLmVsZW1lbnRzLnB1c2goWzAsIDEsIDAsIDBdKTtcclxuICAgICAgICBlbHNlIGlmIChpID09IDIpXHJcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudHMucHVzaChbMCwgMCwgMSwgMF0pO1xyXG4gICAgICAgIGVsc2UgaWYgKGkgPT0gMylcclxuICAgICAgICAgICAgdGhpcy5lbGVtZW50cy5wdXNoKFswLCAwLCAwLCAxXSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXM7XHJcbn07XHJcblxyXG5NYXRyaXgucHJvdG90eXBlLm1ha2UzeDMgPSBmdW5jdGlvbigpXHJcbntcclxuICAgIGlmICh0aGlzLmVsZW1lbnRzLmxlbmd0aCAhPSA0IHx8XHJcbiAgICAgICAgdGhpcy5lbGVtZW50c1swXS5sZW5ndGggIT0gNClcclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuXHJcbiAgICByZXR1cm4gTWF0cml4LmNyZWF0ZShbW3RoaXMuZWxlbWVudHNbMF1bMF0sIHRoaXMuZWxlbWVudHNbMF1bMV0sIHRoaXMuZWxlbWVudHNbMF1bMl1dLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIFt0aGlzLmVsZW1lbnRzWzFdWzBdLCB0aGlzLmVsZW1lbnRzWzFdWzFdLCB0aGlzLmVsZW1lbnRzWzFdWzJdXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICBbdGhpcy5lbGVtZW50c1syXVswXSwgdGhpcy5lbGVtZW50c1syXVsxXSwgdGhpcy5lbGVtZW50c1syXVsyXV1dKTtcclxufTtcclxuXHJcblZlY3Rvci5wcm90b3R5cGUuZmxhdHRlbiA9IGZ1bmN0aW9uICgpXHJcbntcclxuICAgIHJldHVybiB0aGlzLmVsZW1lbnRzO1xyXG59O1xyXG5cclxuZnVuY3Rpb24gbWh0KG0pIHtcclxuICAgIHZhciBzID0gXCJcIjtcclxuICAgIGlmIChtLmxlbmd0aCA9PSAxNikge1xyXG4gICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgNDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHMgKz0gXCI8c3BhbiBzdHlsZT0nZm9udC1mYW1pbHk6IG1vbm9zcGFjZSc+W1wiICsgbVtpKjQrMF0udG9GaXhlZCg0KSArIFwiLFwiICsgbVtpKjQrMV0udG9GaXhlZCg0KSArIFwiLFwiICsgbVtpKjQrMl0udG9GaXhlZCg0KSArIFwiLFwiICsgbVtpKjQrM10udG9GaXhlZCg0KSArIFwiXTwvc3Bhbj48YnI+XCI7XHJcbiAgICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChtLmxlbmd0aCA9PSA5KSB7XHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAzOyBpKyspIHtcclxuICAgICAgICAgICAgcyArPSBcIjxzcGFuIHN0eWxlPSdmb250LWZhbWlseTogbW9ub3NwYWNlJz5bXCIgKyBtW2kqMyswXS50b0ZpeGVkKDQpICsgXCIsXCIgKyBtW2kqMysxXS50b0ZpeGVkKDQpICsgXCIsXCIgKyBtW2kqMysyXS50b0ZpeGVkKDQpICsgXCJdPC9mb250Pjxicj5cIjtcclxuICAgICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBtLnRvU3RyaW5nKCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcztcclxufVxyXG5cclxuLy9cclxuLy8gZ2x1TG9va0F0XHJcbi8vXHJcbmZ1bmN0aW9uIG1ha2VMb29rQXQoZXgsIGV5LCBleixcclxuICAgICAgICAgICAgICAgICAgICBjeCwgY3ksIGN6LFxyXG4gICAgICAgICAgICAgICAgICAgIHV4LCB1eSwgdXopXHJcbntcclxuICAgIHZhciBleWUgPSAkVihbZXgsIGV5LCBlel0pO1xyXG4gICAgdmFyIGNlbnRlciA9ICRWKFtjeCwgY3ksIGN6XSk7XHJcbiAgICB2YXIgdXAgPSAkVihbdXgsIHV5LCB1el0pO1xyXG5cclxuICAgIHZhciBtYWc7XHJcblxyXG4gICAgdmFyIHogPSBleWUuc3VidHJhY3QoY2VudGVyKS50b1VuaXRWZWN0b3IoKTtcclxuICAgIHZhciB4ID0gdXAuY3Jvc3MoeikudG9Vbml0VmVjdG9yKCk7XHJcbiAgICB2YXIgeSA9IHouY3Jvc3MoeCkudG9Vbml0VmVjdG9yKCk7XHJcblxyXG4gICAgdmFyIG0gPSAkTShbW3guZSgxKSwgeC5lKDIpLCB4LmUoMyksIDBdLFxyXG4gICAgICAgICAgICAgICAgW3kuZSgxKSwgeS5lKDIpLCB5LmUoMyksIDBdLFxyXG4gICAgICAgICAgICAgICAgW3ouZSgxKSwgei5lKDIpLCB6LmUoMyksIDBdLFxyXG4gICAgICAgICAgICAgICAgWzAsIDAsIDAsIDFdXSk7XHJcblxyXG4gICAgdmFyIHQgPSAkTShbWzEsIDAsIDAsIC1leF0sXHJcbiAgICAgICAgICAgICAgICBbMCwgMSwgMCwgLWV5XSxcclxuICAgICAgICAgICAgICAgIFswLCAwLCAxLCAtZXpdLFxyXG4gICAgICAgICAgICAgICAgWzAsIDAsIDAsIDFdXSk7XHJcbiAgICByZXR1cm4gbS54KHQpO1xyXG59XHJcblxyXG4vL1xyXG4vLyBnbE9ydGhvXHJcbi8vXHJcbmZ1bmN0aW9uIG1ha2VPcnRobyhsZWZ0LCByaWdodCxcclxuICAgICAgICAgICAgICAgICAgIGJvdHRvbSwgdG9wLFxyXG4gICAgICAgICAgICAgICAgICAgem5lYXIsIHpmYXIpXHJcbntcclxuICAgIHZhciB0eCA9IC0ocmlnaHQrbGVmdCkvKHJpZ2h0LWxlZnQpO1xyXG4gICAgdmFyIHR5ID0gLSh0b3ArYm90dG9tKS8odG9wLWJvdHRvbSk7XHJcbiAgICB2YXIgdHogPSAtKHpmYXIrem5lYXIpLyh6ZmFyLXpuZWFyKTtcclxuXHJcbiAgICByZXR1cm4gJE0oW1syLyhyaWdodC1sZWZ0KSwgMCwgMCwgdHhdLFxyXG4gICAgICAgICAgICAgICBbMCwgMi8odG9wLWJvdHRvbSksIDAsIHR5XSxcclxuICAgICAgICAgICAgICAgWzAsIDAsIC0yLyh6ZmFyLXpuZWFyKSwgdHpdLFxyXG4gICAgICAgICAgICAgICBbMCwgMCwgMCwgMV1dKTtcclxufVxyXG5cclxuLy9cclxuLy8gZ2x1UGVyc3BlY3RpdmVcclxuLy9cclxuZnVuY3Rpb24gbWFrZVBlcnNwZWN0aXZlKGZvdnksIGFzcGVjdCwgem5lYXIsIHpmYXIpXHJcbntcclxuICAgIHZhciB5bWF4ID0gem5lYXIgKiBNYXRoLnRhbihmb3Z5ICogTWF0aC5QSSAvIDM2MC4wKTtcclxuICAgIHZhciB5bWluID0gLXltYXg7XHJcbiAgICB2YXIgeG1pbiA9IHltaW4gKiBhc3BlY3Q7XHJcbiAgICB2YXIgeG1heCA9IHltYXggKiBhc3BlY3Q7XHJcblxyXG4gICAgcmV0dXJuIG1ha2VGcnVzdHVtKHhtaW4sIHhtYXgsIHltaW4sIHltYXgsIHpuZWFyLCB6ZmFyKTtcclxufVxyXG5cclxuLy9cclxuLy8gZ2xGcnVzdHVtXHJcbi8vXHJcbmZ1bmN0aW9uIG1ha2VGcnVzdHVtKGxlZnQsIHJpZ2h0LFxyXG4gICAgICAgICAgICAgICAgICAgICBib3R0b20sIHRvcCxcclxuICAgICAgICAgICAgICAgICAgICAgem5lYXIsIHpmYXIpXHJcbntcclxuICAgIHZhciBYID0gMip6bmVhci8ocmlnaHQtbGVmdCk7XHJcbiAgICB2YXIgWSA9IDIqem5lYXIvKHRvcC1ib3R0b20pO1xyXG4gICAgdmFyIEEgPSAocmlnaHQrbGVmdCkvKHJpZ2h0LWxlZnQpO1xyXG4gICAgdmFyIEIgPSAodG9wK2JvdHRvbSkvKHRvcC1ib3R0b20pO1xyXG4gICAgdmFyIEMgPSAtKHpmYXIrem5lYXIpLyh6ZmFyLXpuZWFyKTtcclxuICAgIHZhciBEID0gLTIqemZhcip6bmVhci8oemZhci16bmVhcik7XHJcblxyXG4gICAgcmV0dXJuICRNKFtbWCwgMCwgQSwgMF0sXHJcbiAgICAgICAgICAgICAgIFswLCBZLCBCLCAwXSxcclxuICAgICAgICAgICAgICAgWzAsIDAsIEMsIERdLFxyXG4gICAgICAgICAgICAgICBbMCwgMCwgLTEsIDBdXSk7XHJcbn1cclxuXHJcbi8vXHJcbi8vIGdsT3J0aG9cclxuLy9cclxuZnVuY3Rpb24gbWFrZU9ydGhvKGxlZnQsIHJpZ2h0LCBib3R0b20sIHRvcCwgem5lYXIsIHpmYXIpXHJcbntcclxuICAgIHZhciB0eCA9IC0gKHJpZ2h0ICsgbGVmdCkgLyAocmlnaHQgLSBsZWZ0KTtcclxuICAgIHZhciB0eSA9IC0gKHRvcCArIGJvdHRvbSkgLyAodG9wIC0gYm90dG9tKTtcclxuICAgIHZhciB0eiA9IC0gKHpmYXIgKyB6bmVhcikgLyAoemZhciAtIHpuZWFyKTtcclxuXHJcbiAgICByZXR1cm4gJE0oW1syIC8gKHJpZ2h0IC0gbGVmdCksIDAsIDAsIHR4XSxcclxuICAgICAgICAgICBbMCwgMiAvICh0b3AgLSBib3R0b20pLCAwLCB0eV0sXHJcbiAgICAgICAgICAgWzAsIDAsIC0yIC8gKHpmYXIgLSB6bmVhciksIHR6XSxcclxuICAgICAgICAgICBbMCwgMCwgMCwgMV1dKTtcclxufSJdfQ==
